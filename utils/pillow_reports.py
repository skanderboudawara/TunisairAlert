#!/usr/bin/python3
from PIL import Image, ImageDraw, ImageFont  # Importing PILLOW
import os  # Create and organize folders
from utils.sql_func import execute_sql
from utils.utility import FontsTunisAlert, FileFolderManager, TimeAttribute, is_blank
from utils.const import (
    FONT_SIZE,
    SQL_OPERATORS,
    TYPE_FLIGHTS,
    SQL_TABLE_NAME,
    AIRLINE_NAMES,
    FLIGHT_STATUS,
)

# Adding Airlines
######################################
# Function to create the plotlib
#####################################
from utils.matplotlib_graphs import (
    plot_from_to_airport,
    plot_tunisair_arrival_dep_delays,
)


def get_text_dimensions(text_string: str, font):
    """_summary_
    will return the dimensions in pixels of the text
    Args:
        text_string (str): the text string that will be outputted
        font (ImageFont): the font used for the text

    Returns:
        _type_: text_width and text_height
    """
    # https://stackoverflow.com/a/46220683/9263761
    ascent, descent = font.getmetrics()

    text_width = font.getmask(text_string).getbbox()[2]
    text_height = font.getmask(text_string).getbbox()[3] + descent

    return (text_width, text_height)


def add_banner(report, x, y, label: str, value):
    """_summary_
    Function to create the label and it's value
    the label will be in orange
    the value will be in white
    Args:
        report (ImageDraw): the report image pillow
        x (_type_): the x position
        y (_type_): the y position
        label (str): the label string will be in orange
        value (_type_): the value of the label will be in white

    Returns:
        _type_: the image updated with the new Banner LABEL : VALUE
    """

    report.text(
        (x + 10, y),
        label,
        font=ImageFont.truetype(FontsTunisAlert().skyfontInverted, FONT_SIZE),
        fill="black",
    )
    width_text, height_text = get_text_dimensions(
        label, ImageFont.truetype(FontsTunisAlert().skyfontInverted, FONT_SIZE)
    )
    report.text(
        (x + width_text + 10, y),
        str(value),
        font=ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE),
        fill="white",
    )
    report.text(
        (x + 10, y),
        label,
        font=ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE),
        fill="orange",
    )

    return get_text_dimensions(
        f"{label} {value}", ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE)
    )


def paste_plots(reportImg, x, y, plot_pic: str):
    """_summary_
    to past plots from matplotlib to the report
    Args:
        report (Image): he report from PILLOW
        x (_type_): position in x
        y (_type_): position in y
        plot_pic (str): the path of the plot picture generated by Matplotlib

    Returns:
        _type_: the image with the plot picture generated by matplotlib pasted
    """
    with Image.open(plot_pic) as plot_img:
        reportImg.paste(plot_img, (x, y))
    os.remove(plot_pic)
    return reportImg


def paste_kpi(
    report,
    v_start_arr,
    v_start_dep,
    v_start,
    h_start,
    query_date_formatted,
):
    """_summary_
    to create 2 rounded blocks and insert KPI ,
    Count Min Max AVG per Departure Arrival

    Args:
        report (_type_): the report from PILLOW
        v_start_arr (_type_): position in x for arrival
        v_start_dep (_type_): position in x for departure
        v_start (_type_): global x pos
        h_start (_type_): global y pos
        query_date_formatted (_type_): query date formatted DD/MM/YYYY

    Returns:
        _type_: the image updated with relevant count, MIN, MAX AVG KPI
    """
    for rounded_start in [v_start_arr, v_start_dep]:
        report.rounded_rectangle(
            (rounded_start, h_start + 35, rounded_start + 480, h_start + 115),
            radius=20,
            outline="orange",
        )

    for type_f in TYPE_FLIGHTS:
        h_start_bytype = h_start + 45
        v_start = (v_start_dep if type_f == "DEPARTURE" else v_start_arr) + 50

        # Counting how many delays
        count_nb = execute_sql(
            f'''SELECT COUNT(*) FROM {SQL_TABLE_NAME} WHERE DEPARTURE_DATE="{str(query_date_formatted)}" AND AIRLINE="TU" AND {type_f}_DELAY<>"0" AND {type_f}_DELAY<>"" AND FLIGHT_STATUS<>"cancelled"''',
            "fetchone",
        )[0]
        if type_f == "ARRIVAL":
            nb_delays_arr = count_nb
        elif type_f == "DEPARTURE":
            nb_delays_dep = count_nb
        width_text, height_text = add_banner(
            report, v_start +
            30, h_start_bytype, f"DELAYED {type_f}:", f"{count_nb}"
        )
        h_start_bytype = h_start + 85

        # add more info on MIN MAX AVG
        for sql_op in SQL_OPERATORS:
            sql_execute_query = execute_sql(
                f'''SELECT {sql_op}({type_f}_DELAY) FROM {SQL_TABLE_NAME} WHERE DEPARTURE_DATE="{str(query_date_formatted)}" AND AIRLINE="TU" AND {type_f}_DELAY<>"0" AND {type_f}_DELAY<>"" AND FLIGHT_STATUS<>"cancelled"''',
                "fetchone",
            )[0]
            result_fetch = int(
                0
                if (((sql_execute_query is None)) | (is_blank(sql_execute_query)))
                else sql_execute_query
            )
            result_fetch = int(round(result_fetch, 0))
            if (sql_op == "MAX") & (type_f == "ARRIVAL"):
                max_arrival_delay = result_fetch
            width_text, height_text = add_banner(
                report, v_start, h_start_bytype, f"{sql_op}:", f"{result_fetch}M"
            )
            v_start = v_start + width_text
    return v_start, h_start, max_arrival_delay, nb_delays_arr, nb_delays_dep


def past_worse_flight(report, max_arrival_delay, h_start, query_date_formatted: str):
    """_summary_
    Args:
        report (_type_): the report from PILLOW
        max_arrival_delay (_type_): the max queried arrival delay
        h_start (_type_):  global y pos
        query_date_formatted (str): query date formatted DD/MM/YYYY

    Returns:
        _type_: the image updated with the worse flight made by Tunisair
    """
    worse_flight = (
        []
        if max_arrival_delay == 0
        else execute_sql(
            f'SELECT DEPARTURE_AIRPORT, ARRIVAL_AIRPORT, FLIGHT_NUMBER, AIRLINE FROM {SQL_TABLE_NAME}  WHERE DEPARTURE_DATE="{query_date_formatted}"  AND AIRLINE="TU" AND ARRIVAL_DELAY="{str(max_arrival_delay)}"  AND FLIGHT_STATUS<>"cancelled" ',
            "fetchone",
        )
    )

    h_worse_flight = h_start + 125
    return (
        _extracted_from_past_worse_flight_15(
            worse_flight, report, h_worse_flight, max_arrival_delay
        )
        if max_arrival_delay > 0
        else _extracted_from_past_worse_flight_66(report, h_worse_flight)
    )


# TODO Rename this here and in `past_worse_flight`
def _extracted_from_past_worse_flight_66(report, h_worse_flight):
    width_label, height_label = get_text_dimensions(
        "ALL FLIGHTS ARE ON TIME",
        ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE),
    )

    add_banner(
        report, (1080 - width_label) /
        2, h_worse_flight, "ALL FLIGHTS ARE ON TIME", ""
    )

    result = "----------"
    width_text, height_text = get_text_dimensions(
        result, ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE)
    )

    position_relative = (1080 - width_text) / 2
    report.text(
        (position_relative, h_worse_flight + height_label + 10),
        result,
        font=ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE),
        fill="white",
    )

    return result


# TODO Rename this here and in `past_worse_flight`
def _extracted_from_past_worse_flight_15(
    worse_flight, report, h_worse_flight, max_arrival_delay
):
    airport_worse_dep = worse_flight[0]
    airport_worse_arr = worse_flight[1]
    worse_flight_number = worse_flight[2]
    worse_airline = AIRLINE_NAMES[worse_flight[3]]
    width_label, height_label = get_text_dimensions(
        f"WORST FLIGHT: {worse_airline} {worse_flight_number}",
        ImageFont.truetype(FontsTunisAlert().skyfont, 20),
    )

    add_banner(
        report,
        (1080 - width_label) / 2,
        h_worse_flight,
        "WORST FLIGHT:",
        f"{worse_airline} {worse_flight_number}",
    )

    result = str(
        f"{airport_worse_dep} -----Delay of {str(max_arrival_delay)}M----> {airport_worse_arr}"
    )

    width_text, height_text = get_text_dimensions(
        result, ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE)
    )

    position_relative = (1080 - width_text) / 2
    report.text(
        (position_relative - 40, h_worse_flight + height_label + 15),
        "Q",
        font=ImageFont.truetype(FontsTunisAlert().glyphAirport, FONT_SIZE),
        fill="white",
    )

    report.text(
        (position_relative, h_worse_flight + height_label + 15),
        result,
        font=ImageFont.truetype(FontsTunisAlert().skyfont, FONT_SIZE),
        fill="white",
    )

    report.text(
        (position_relative + width_text + 10, h_worse_flight + height_label + 15),
        "P",
        font=ImageFont.truetype(FontsTunisAlert().glyphAirport, FONT_SIZE),
        fill="white",
    )

    return result


def past_titles(report, datetime_query):
    """_summary_
    To generate titles in the white AREA
    Args:
        report (_type_): the report from PILLOW
        datetime_query (_type_): query date formatted DD/MM/YYYY
    """
    # Last update hour
    report.text(
        (55, 60),
        f"LAST UPDATE AT {TimeAttribute(datetime_query).full_hour}",
        font=ImageFont.truetype(FontsTunisAlert().skyfont, 9),
        fill="black",
    )
    # Big Title
    report.text(
        (260, 10),
        f"TUNISAIR DAILY INGEST {TimeAttribute(datetime_query).full_day}",
        font=ImageFont.truetype(FontsTunisAlert().skyfont, 25),
        fill="black",
    )
    # Subtitle
    report.text(
        (260, 50),
        "SCOPE FROM/TO Tunis-Carthage International Airport",
        font=ImageFont.truetype(FontsTunisAlert().skyfont, 15),
        fill="black",
    )
    return report


def flight_status_kpi(report, query_date_formatted: str, h_start, v_start_dep):
    """_summary_
    To generate the KPI count per flight status (Scheduled, Canceled, Active, Landed)

    Args:
        report (_type_): the report from PILLOW
        query_date_formatted (str): query date formatted DD/MM/YYYY
        h_start (_type_): global y pos
        v_start_dep (_type_): position in x for departure

    Returns:
        _type_: the image updated with the KPI by flight status
    """
    h_start = h_start + 15
    width_text, height_text = add_banner(
        report, v_start_dep, h_start, "TUNISAIR FLIGHTS", ""
    )

    v_start = v_start_dep + width_text + 10
    for status in FLIGHT_STATUS:
        count_sql_status = execute_sql(
            f'''SELECT COUNT(*) FROM {SQL_TABLE_NAME} WHERE DEPARTURE_DATE="{query_date_formatted}" AND AIRLINE="TU"  AND FLIGHT_STATUS="{status}"''',
            "fetchone",
        )[0]

        width_text, height_text = add_banner(
            report, v_start, h_start, f"{status}:", count_sql_status
        )

        v_start = v_start + width_text + 10
    return v_start, h_start


def get_picture_to_save_loc(datetime_query):
    """_summary_
    To create the dir and prepare the save of the report png
    Args:
        datetime_query (_type_): the datetime query

    Returns:
        _type_: the file path where to store the report
    """
    return FileFolderManager(
        dir=f"reports/{TimeAttribute(datetime_query).month}",
        name_file=f"{TimeAttribute(datetime_query).short_under_score}_report.png",
    ).file_dir


def generate_report(datetime_query):
    """_summary_
    Function to generate the daily report as function of current time
    Args:
        datetime_query (_type_): datetime

    Returns:
        _type_: the path of the report image
    """

    # Create necessary folders and paths
    query_date_formatted = TimeAttribute(datetime_query).dateformat
    picture_to_save = get_picture_to_save_loc(datetime_query)
    reportImg = Image.new("RGB", (1080, 720), color="white")

    # LOGO BLOCK
    with Image.open(
        FileFolderManager(directory="utils",
                          name_file="tunisair_alert_logo.png").file_dir
    ) as tunisair_logo:
        reportImg.paste(tunisair_logo, (25, 7))

    report = ImageDraw.Draw(reportImg)
    # TITLES BLOCKS
    past_titles(report, datetime_query)

    # Positions
    v_start_dep = 15  # vertical position for DEPARTURES
    v_start_arr = 580  # vertical position for ARRIVALS
    h_start = 80  # horizontal position

    # KPI BLOCKS
    report.rectangle((0, h_start, 1080, 720), fill="black")

    # To get the repartition count by flight status
    v_start, h_start = flight_status_kpi(
        report, query_date_formatted, h_start, v_start_dep
    )

    # To prepare the KPI of counting in Departure & Counting in Arrivals
    # 2 rounded rectangles that will contain the KPIs
    v_start, h_start, max_arrival_delay, nb_delays_arr, nb_delays_dep = paste_kpi(
        report, v_start_arr, v_start_dep, v_start, h_start, query_date_formatted
    )

    # Get the information of WORSE Flight
    text_worse_flight = past_worse_flight(
        report, max_arrival_delay, h_start, query_date_formatted
    )

    # PLOT BLOCKS
    paste_plots(
        reportImg, v_start_dep, 290, plot_tunisair_arrival_dep_delays(
            datetime_query)
    )

    plot_h_pos = 470
    paste_plots(
        reportImg,
        v_start_dep,
        plot_h_pos,
        plot_from_to_airport(datetime_query, "DEPARTURE", "TUNISIA", "FRANCE"),
    )

    paste_plots(
        reportImg,
        530,
        plot_h_pos,
        plot_from_to_airport(datetime_query, "ARRIVAL", "FRANCE", "TUNISIA"),
    )

    report.rounded_rectangle(
        (v_start_dep, 290, 1060, 705), radius=20, outline="orange")

    # SAVE PICTURE
    reportImg.save(picture_to_save)
    print(
        f"Daily report created for {TimeAttribute(datetime_query).short_under_score}")
    return (
        picture_to_save,
        nb_delays_arr,
        nb_delays_dep,
        max_arrival_delay,
        text_worse_flight,
    )
